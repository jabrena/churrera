@startuml
!theme plain
title Churrera Core Module - Class Diagram

package "info.jab.churrera.workflow" {
    class WorkflowParser {
        -logger: Logger
        +parse(File): WorkflowData
        +parse(Path): WorkflowData
        +determineWorkflowType(File): WorkflowType
        -parseV2Workflow(Node): WorkflowData
        -parseParallelWorkflow(Element): WorkflowData
        -parseSequenceInfo(Element): SequenceInfo
        -inferTypeFromExtension(String): String
    }
    
    class WorkflowData {
        -launchPrompt: PromptInfo
        -model: String
        -repository: String
        -updatePrompts: List<PromptInfo>
        -parallelWorkflowData: ParallelWorkflowData
        -timeoutMillis: Long
        -fallbackSrc: String
        +getLaunchPrompt(): PromptInfo
        +getModel(): String
        +getRepository(): String
        +getUpdatePrompts(): List<PromptInfo>
        +getParallelWorkflowData(): ParallelWorkflowData
        +isParallelWorkflow(): boolean
        +getUpdateAgentCount(): int
        +hasUpdateAgents(): boolean
        +getTimeoutMillis(): Long
        +getFallbackSrc(): String
    }
    
    class WorkflowValidator {
        +validate(WorkflowData): void
    }
    
    class PmlValidator {
        +validate(File): void
    }
    
    class PromptInfo {
        -srcFile: String
        -type: String
        -bindResultExp: String
        +getSrcFile(): String
        +getType(): String
        +getBindResultExp(): String
    }
    
    class SequenceInfo {
        -model: String
        -repository: String
        -prompts: List<PromptInfo>
        -timeoutMillis: Long
        -fallbackSrc: String
        +getModel(): String
        +getRepository(): String
        +getPrompts(): List<PromptInfo>
        +getTimeoutMillis(): Long
        +getFallbackSrc(): String
    }
    
    class ParallelWorkflowData {
        -parallelPrompt: PromptInfo
        -bindResultType: String
        -sequences: List<SequenceInfo>
        -timeoutMillis: Long
        -fallbackSrc: String
        +getParallelPrompt(): PromptInfo
        +getBindResultType(): String
        +getSequences(): List<SequenceInfo>
        +getTimeoutMillis(): Long
        +getFallbackSrc(): String
    }
    
    class TimeoutParser {
        +parseToMillis(String): Long
    }
    
    class ExpressionEvaluator {
        +replaceInputPlaceholder(String, String): String
        +evaluateExpression(String, String): String
    }
    
    class BindResultTypeMapper {
        +mapBindResultType(String): String
    }
    
    enum WorkflowType {
        SEQUENCE
        PARALLEL
    }
    
    class WorkflowParseException extends Exception {
        +WorkflowParseException(String)
        +WorkflowParseException(String, Throwable)
    }
}

package "info.jab.churrera.agent" {
    enum AgentState {
        PENDING
        RUNNING
        COMPLETED
        FAILED
        UNKNOWN
        +of(AgentResponse): AgentState
        +isTerminal(): boolean
    }
}

package "info.jab.churrera.util" {
    class CursorApiKeyResolver {
        +resolveApiKey(): String
    }
    
    class PropertyResolver {
        +getProperty(String, String): Optional<String>
    }
    
    class PmlConverter {
        +toMarkdownFromContent(String): String
        +toMarkdownFromContent(String, String): String
    }
    
    class ClasspathResolver {
        +resolveResource(String): InputStream
    }
    
    class ConversationJsonDeserializer {
        +deserialize(JsonParser, DeserializationContext): ConversationResponse
    }
}

WorkflowParser --> WorkflowData
WorkflowParser --> WorkflowType
WorkflowParser --> PromptInfo
WorkflowParser --> SequenceInfo
WorkflowParser --> ParallelWorkflowData
WorkflowParser --> TimeoutParser
WorkflowParser --> WorkflowParseException

WorkflowData --> PromptInfo
WorkflowData --> ParallelWorkflowData
WorkflowData --> WorkflowType

ParallelWorkflowData --> PromptInfo
ParallelWorkflowData --> SequenceInfo

SequenceInfo --> PromptInfo

WorkflowValidator --> WorkflowData

ExpressionEvaluator --> WorkflowData

@enduml
