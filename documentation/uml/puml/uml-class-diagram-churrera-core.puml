@startuml
!theme plain
title Churrera Core Module - Class Diagram

package "info.jab.churrera.workflow" {
  class WorkflowParser {
    + parse(File): WorkflowData
    + parse(Path): WorkflowData
    + {static} determineWorkflowType(File): WorkflowType
    - parseV2Workflow(Node): WorkflowData
    - parseParallelWorkflow(Element): WorkflowData
    - parseSequenceInfo(Element): SequenceInfo
    - inferTypeFromExtension(String): String
  }
  
  class WorkflowData {
    - launchPrompt: PromptInfo
    - model: String
    - repository: String
    - updatePrompts: List<PromptInfo>
    - parallelWorkflowData: ParallelWorkflowData
    - timeoutMillis: Long
    - fallbackSrc: String
    + getLaunchPrompt(): PromptInfo
    + getModel(): String
    + getRepository(): String
    + getUpdatePrompts(): List<PromptInfo>
    + getParallelWorkflowData(): ParallelWorkflowData
    + isParallelWorkflow(): boolean
  }
  
  class WorkflowValidator {
    + validate(WorkflowData): void
  }
  
  class PmlValidator {
    + validate(File): void
  }
  
  class WorkflowParseException {
    + message: String
    + cause: Throwable
  }
  
  enum WorkflowType {
    SEQUENCE
    PARALLEL
  }
  
  class PromptInfo {
    - srcFile: String
    - type: String
    - bindResultExp: String
    + getSrcFile(): String
    + getType(): String
    + getBindResultExp(): String
  }
  
  class SequenceInfo {
    - model: String
    - repository: String
    - prompts: List<PromptInfo>
    - timeoutMillis: Long
    - fallbackSrc: String
    + getModel(): String
    + getRepository(): String
    + getPrompts(): List<PromptInfo>
    + getTimeoutMillis(): Long
    + getFallbackSrc(): String
  }
  
  class ParallelWorkflowData {
    - parallelPrompt: PromptInfo
    - bindResultType: String
    - sequences: List<SequenceInfo>
    - timeoutMillis: Long
    - fallbackSrc: String
    + getParallelPrompt(): PromptInfo
    + getBindResultType(): String
    + getSequences(): List<SequenceInfo>
    + getTimeoutMillis(): Long
    + getFallbackSrc(): String
  }
  
  class TimeoutParser {
    + {static} parseToMillis(String): Long
  }
  
  class ExpressionEvaluator {
    + {static} replaceInputPlaceholder(String, String): String
    + {static} evaluateExpression(String, Map<String, Object>): Object
  }
  
  class BindResultTypeMapper {
    + {static} mapType(String): Class<?>
  }
}

package "info.jab.churrera.util" {
  class PmlConverter {
    + convertToMarkdown(String): String
  }
  
  class PropertyResolver {
    + getProperty(String, String): Optional<String>
  }
  
  class CursorApiKeyResolver {
    + resolveApiKey(): String
  }
  
  class ClasspathResolver {
    + {static} resolveClasspathResource(String): InputStream
  }
  
  class ConversationJsonDeserializer {
    + deserialize(String, String): List<Object>
  }
}

' Relationships
WorkflowParser --> WorkflowData : creates
WorkflowParser --> SequenceInfo : creates
WorkflowParser --> ParallelWorkflowData : creates
WorkflowParser --> PromptInfo : creates
WorkflowParser --> WorkflowType : returns
WorkflowParser --> WorkflowParseException : throws

WorkflowData --> PromptInfo : contains
WorkflowData --> ParallelWorkflowData : contains
WorkflowData --> WorkflowType : uses

ParallelWorkflowData --> PromptInfo : contains
ParallelWorkflowData --> SequenceInfo : contains

SequenceInfo --> PromptInfo : contains

WorkflowValidator --> WorkflowData : validates

PmlValidator --> File : validates

ExpressionEvaluator --> String : processes
BindResultTypeMapper --> Class : maps

@enduml
