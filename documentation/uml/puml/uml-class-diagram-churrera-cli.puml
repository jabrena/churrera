@startuml
!theme plain
title Churrera CLI Module - Class Diagram
scale 0.6

package "info.jab.churrera.cli" {
  class ChurreraCLI {
    - apiKeyResolver: CursorApiKeyResolver
    - propertyResolver: PropertyResolver
    - jobRepository: JobRepository
    - apiClient: ApiClient
    - defaultApi: DefaultApi
    - cliAgent: CLIAgent
    - workflowParser: WorkflowParser
    - jobProcessor: JobProcessor
    - workflowValidator: WorkflowValidator
    - pmlValidator: PmlValidator
    + main(String[]): void
    + createRunCmd(): RunCommand
    + run(): void
  }
}

package "info.jab.churrera.cli.command.run" {
  class RunCommand {
    - workflowPath: String
    - deleteOnCompletion: boolean
    - deleteOnSuccessCompletion: boolean
    - jobRepository: JobRepository
    - jobProcessor: JobProcessor
    - pollingIntervalSeconds: int
    - cliAgent: CLIAgent
    - jobCreationService: JobCreationService
    - jobDisplayService: JobDisplayService
    - jobDeletionService: JobDeletionService
    - jobLogDisplayService: JobLogDisplayService
    + call(): Integer
  }
  
  class JobCreationService {
    - jobRepository: JobRepository
    - workflowValidator: WorkflowValidator
    - workflowParser: WorkflowParser
    - pmlValidator: PmlValidator
    - cliAgent: CLIAgent
    + createJob(String): JobCreationResult
  }
  
  class JobDisplayService {
    - jobRepository: JobRepository
    + displayJobStatus(String): void
  }
  
  class JobDeletionService {
    - jobRepository: JobRepository
    - cliAgent: CLIAgent
    + handleDeletion(String, Job, List<Job>, boolean, boolean): void
  }
  
  class JobPollingService {
    - jobProcessor: JobProcessor
    - jobRepository: JobRepository
    - jobDisplayService: JobDisplayService
    - completionCheckerFactory: CompletionCheckerFactory
    - pollingIntervalSeconds: int
    + executePollingLoop(String): ExecutionResult
  }
  
  class CompletionCheckerFactory {
    - jobRepository: JobRepository
    + createChecker(WorkflowType): CompletionChecker
  }
  
  interface CompletionChecker {
    + checkCompletion(String): CompletionCheckResult
  }
  
  class SimpleWorkflowCompletionChecker {
    - jobRepository: JobRepository
    + checkCompletion(String): CompletionCheckResult
  }
  
  class ParallelWorkflowCompletionChecker {
    - jobRepository: JobRepository
    + checkCompletion(String): CompletionCheckResult
  }
}

package "info.jab.churrera.cli.model" {
  class Job {
    + jobId: String
    + path: String
    + cursorAgentId: String
    + model: String
    + repository: String
    + status: AgentState
    + createdAt: LocalDateTime
    + lastUpdate: LocalDateTime
    + parentJobId: String
    + result: String
    + type: WorkflowType
    + timeoutMillis: Long
    + workflowStartTime: LocalDateTime
    + fallbackSrc: String
    + fallbackExecuted: Boolean
  }
  
  class JobWithDetails {
    + job: Job
    + prompts: List<Prompt>
  }
  
  class Prompt {
    + promptId: String
    + jobId: String
    + srcFile: String
    + type: String
    + createdAt: LocalDateTime
    + lastUpdate: LocalDateTime
  }
  
  enum AgentState {
    CREATING
    RUNNING
    SUCCESS
    ERROR
    CANCELLED
    + isActive(): boolean
    + isSuccessful(): boolean
    + isFailed(): boolean
    + isTerminal(): boolean
  }
}

package "info.jab.churrera.cli.repository" {
  class JobRepository {
    + save(Job): void
    + findById(String): Optional<Job>
    + findUnfinishedJobs(): List<Job>
    + findJobWithDetails(String): Optional<JobWithDetails>
    + savePrompt(Prompt): void
    + close(): void
  }
}

package "info.jab.churrera.cli.service" {
  class CLIAgent {
    - cursorAgentManagement: CursorAgentManagement
    - cursorAgentInformation: CursorAgentInformation
    - cursorAgentGeneralEndpoints: CursorAgentGeneralEndpoints
    - jobRepository: JobRepository
    - pmlConverter: PmlConverter
    + launchAgentForJob(Job, String, String, String, boolean): String
    + followUpForPrompt(String, String, String, String): String
    + getAgentStatus(String): AgentState
    + updateJobStatusInDatabase(Job, AgentState): void
    + getModels(): List<String>
    + getRepositories(): List<String>
  }
  
  class JobProcessor {
    - jobRepository: JobRepository
    - workflowFileService: WorkflowFileService
    - sequenceWorkflowHandler: SequenceWorkflowHandler
    - parallelWorkflowHandler: ParallelWorkflowHandler
    - childWorkflowHandler: ChildWorkflowHandler
    + processJobs(): void
  }
  
  class AgentLauncher {
    - cliAgent: CLIAgent
    - jobRepository: JobRepository
    - workflowFileService: WorkflowFileService
    + launchJobAgent(Job, WorkflowData): void
  }
  
  class PromptProcessor {
    - cliAgent: CLIAgent
    - workflowFileService: WorkflowFileService
    + processRemainingPrompts(Job, List<Prompt>, WorkflowData): void
  }
  
  class TimeoutManager {
    - jobRepository: JobRepository
    + checkTimeout(Job): TimeoutCheckResult
    + resetWorkflowStartTimeIfNeeded(Job): Job
    + getElapsedMillis(Job): long
  }
  
  class FallbackExecutor {
    - cliAgent: CLIAgent
    - jobRepository: JobRepository
    - workflowFileService: WorkflowFileService
    + executeFallback(Job, WorkflowData, long, long): void
    + executeFallbackForParallelChildren(Job, ParallelWorkflowData): void
  }
  
  class ResultExtractor {
    - cliAgent: CLIAgent
    - jobRepository: JobRepository
    + extractResults(Job, ParallelWorkflowData): List<Object>
  }
  
  class WorkflowFileService {
    - workflowParser: WorkflowParser
    + parseWorkflow(String): WorkflowData
  }
}

package "info.jab.churrera.cli.service.handler" {
  class SequenceWorkflowHandler {
    - jobRepository: JobRepository
    - cliAgent: CLIAgent
    - agentLauncher: AgentLauncher
    - promptProcessor: PromptProcessor
    - timeoutManager: TimeoutManager
    - fallbackExecutor: FallbackExecutor
    + processWorkflow(Job, List<Prompt>, WorkflowData): void
  }
  
  class ParallelWorkflowHandler {
    - jobRepository: JobRepository
    - cliAgent: CLIAgent
    - agentLauncher: AgentLauncher
    - timeoutManager: TimeoutManager
    - fallbackExecutor: FallbackExecutor
    - resultExtractor: ResultExtractor
    + processWorkflow(Job, WorkflowData): void
  }
  
  class ChildWorkflowHandler {
    - jobRepository: JobRepository
    - cliAgent: CLIAgent
    - agentLauncher: AgentLauncher
    - promptProcessor: PromptProcessor
    - timeoutManager: TimeoutManager
    - fallbackExecutor: FallbackExecutor
    + processWorkflow(Job, WorkflowData, List<Prompt>): void
  }
}

package "info.jab.churrera.cli.util" {
  class GitInfo {
    + print(): void
  }
  
  class JobXmlMapper {
    + toXml(Job): String
    + fromXml(String): Job
  }
  
  class PromptXmlMapper {
    + toXml(Prompt): String
    + fromXml(String): Prompt
  }
  
  class XmlUtils {
    + {static} escapeXml(String): String
  }
}

' Relationships
ChurreraCLI --> JobRepository
ChurreraCLI --> CLIAgent
ChurreraCLI --> JobProcessor
ChurreraCLI --> WorkflowParser
ChurreraCLI --> RunCommand

RunCommand --> JobRepository
RunCommand --> JobProcessor
RunCommand --> JobCreationService
RunCommand --> JobDisplayService
RunCommand --> JobDeletionService
RunCommand --> JobPollingService

JobCreationService --> JobRepository
JobCreationService --> WorkflowParser
JobCreationService --> CLIAgent

JobProcessor --> JobRepository
JobProcessor --> SequenceWorkflowHandler
JobProcessor --> ParallelWorkflowHandler
JobProcessor --> ChildWorkflowHandler
JobProcessor --> WorkflowFileService

SequenceWorkflowHandler --> JobRepository
SequenceWorkflowHandler --> CLIAgent
SequenceWorkflowHandler --> AgentLauncher
SequenceWorkflowHandler --> PromptProcessor
SequenceWorkflowHandler --> TimeoutManager
SequenceWorkflowHandler --> FallbackExecutor

ParallelWorkflowHandler --> JobRepository
ParallelWorkflowHandler --> CLIAgent
ParallelWorkflowHandler --> AgentLauncher
ParallelWorkflowHandler --> TimeoutManager
ParallelWorkflowHandler --> FallbackExecutor
ParallelWorkflowHandler --> ResultExtractor

ChildWorkflowHandler --> JobRepository
ChildWorkflowHandler --> CLIAgent
ChildWorkflowHandler --> AgentLauncher
ChildWorkflowHandler --> PromptProcessor
ChildWorkflowHandler --> TimeoutManager
ChildWorkflowHandler --> FallbackExecutor

CLIAgent --> JobRepository
CLIAgent --> CursorAgentManagement
CLIAgent --> CursorAgentInformation
CLIAgent --> CursorAgentGeneralEndpoints

JobRepository ..> Job : manages
JobRepository ..> Prompt : manages
JobRepository ..> JobWithDetails : returns

Job --> AgentState : has
Job --> WorkflowType : has

CompletionCheckerFactory ..> CompletionChecker : creates
SimpleWorkflowCompletionChecker ..|> CompletionChecker
ParallelWorkflowCompletionChecker ..|> CompletionChecker

@enduml
