@startuml
!theme plain
scale 0.6
title Churrera CLI Module - Class Diagram

package "info.jab.churrera.cli" {
  class ChurreraCLI {
    - CursorApiKeyResolver apiKeyResolver
    - PropertyResolver propertyResolver
    - JobRepository jobRepository
    - ApiClient apiClient
    - DefaultApi defaultApi
    - CLIAgent cliAgent
    - WorkflowParser workflowParser
    - JobProcessor jobProcessor
    - WorkflowValidator workflowValidator
    - PmlValidator pmlValidator
    - String apiKey
    + ChurreraCLI()
    + createRunCmd() : RunCommand
    + run()
    + main(String[] args)
    + printBanner(Supplier<GitInfo>)
  }
}

package "info.jab.churrera.cli.command.run" {
  class RunCommand {
    - String workflowPath
    - boolean deleteOnCompletion
    - boolean deleteOnSuccessCompletion
    - boolean retrieveModels
    - boolean retrieveRepositories
    - boolean showLogs
    - Integer pollingIntervalOverride
    - JobRepository jobRepository
    - JobProcessor jobProcessor
    - int pollingIntervalSeconds
    - CLIAgent cliAgent
    - JobCreationService jobCreationService
    - JobDisplayService jobDisplayService
    - JobDeletionService jobDeletionService
    - JobLogDisplayService jobLogDisplayService
    - CompletionCheckerFactory completionCheckerFactory
    + call() : Integer
    + getJobRepository() : JobRepository
  }
  
  class JobCreationService {
    - JobRepository jobRepository
    - WorkflowValidator workflowValidator
    - WorkflowParser workflowParser
    - PmlValidator pmlValidator
    - CLIAgent cliAgent
    + createJob(String workflowPath) : JobCreationResult
  }
  
  class JobDisplayService {
    - JobRepository jobRepository
    + displayJob(String jobId)
  }
  
  class JobDeletionService {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    + handleDeletion(String jobId, Job job, List<Job> childJobs, boolean deleteOnCompletion, boolean deleteOnSuccessCompletion)
  }
  
  class JobLogDisplayService {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    + displayLogsForJob(Job job)
  }
  
  class JobPollingService {
    - JobProcessor jobProcessor
    - JobRepository jobRepository
    - JobDisplayService jobDisplayService
    - CompletionCheckerFactory completionCheckerFactory
    - int pollingIntervalSeconds
    + executePollingLoop(String jobId) : ExecutionResult
  }
  
  class CompletionCheckerFactory {
    - JobRepository jobRepository
    + createCompletionChecker(WorkflowType type) : CompletionChecker
  }
  
  interface CompletionChecker {
    + checkCompletion(Job job) : CompletionCheckResult
  }
  
  class SimpleWorkflowCompletionChecker {
    + checkCompletion(Job job) : CompletionCheckResult
  }
  
  class ParallelWorkflowCompletionChecker {
    - JobRepository jobRepository
    + checkCompletion(Job job) : CompletionCheckResult
  }
  
  class JobCreationResult {
    + boolean isSuccess()
    + String getJobId()
    + List<String> getErrors()
  }
  
  class ExecutionResult {
    - boolean interrupted
    - AgentState finalStatus
    - List<Job> childJobs
  }
  
  class CompletionCheckResult {
    - boolean isComplete
    - AgentState finalStatus
    - List<Job> childJobs
  }
  
  class TableFormatter {
    + formatTable(List<String> headers, List<List<String>> rows) : String
  }
}

package "info.jab.churrera.cli.model" {
  record Job {
    + String jobId
    + String path
    + String cursorAgentId
    + String model
    + String repository
    + AgentState status
    + LocalDateTime createdAt
    + LocalDateTime lastUpdate
    + String parentJobId
    + String result
    + WorkflowType type
    + Long timeoutMillis
    + LocalDateTime workflowStartTime
    + String fallbackSrc
    + Boolean fallbackExecuted
    + withPath(String) : Job
    + withCursorAgentId(String) : Job
    + withStatus(AgentState) : Job
  }
  
  record Prompt {
    + String promptId
    + String jobId
    + String src
    + String type
    + String status
    + LocalDateTime createdAt
    + String bindResultExp
    + withStatus(String) : Prompt
  }
  
  enum AgentState {
    CREATING
    RUNNING
    COMPLETED
    FAILED
    + isTerminal() : boolean
    + isSuccessful() : boolean
    + isFailed() : boolean
    + of(AgentResponse) : AgentState
  }
  
  class JobWithDetails {
    - Job job
    - List<Prompt> prompts
    + getJob() : Job
    + getPrompts() : List<Prompt>
  }
}

package "info.jab.churrera.cli.repository" {
  class JobRepository {
    - Context context
    - String databasePath
    + JobRepository(PropertyResolver)
    + findAll() : List<Job>
    + findById(String) : Optional<Job>
    + save(Job)
    + deleteById(String)
    + savePrompt(Prompt)
    + findPromptById(String) : Optional<Prompt>
    + findPromptsByJobId(String) : List<Prompt>
    + findJobWithDetails(String) : Optional<JobWithDetails>
    + findUnfinishedJobs() : List<Job>
    + deletePromptsByJobId(String)
    + findJobsByParentId(String) : List<Job>
    + close()
  }
}

package "info.jab.churrera.cli.service" {
  class CLIAgent {
    - CursorAgentManagement cursorAgentManagement
    - CursorAgentInformation cursorAgentInformation
    - CursorAgentGeneralEndpoints cursorAgentGeneralEndpoints
    - JobRepository jobRepository
    - PmlConverter pmlConverter
    + launchAgentForJob(Job, String, String, String, boolean) : String
    + followUpForPrompt(String, String, String, String) : String
    + monitorAgent(String, int) : AgentState
    + getConversation(String) : ConversationResponse
    + getConversationContent(String) : String
    + deleteAgent(String)
    + updateJobCursorIdInDatabase(Job, String, AgentState)
    + updateJobStatusInDatabase(Job, AgentState)
    + updatePromptInDatabase(Prompt, String)
    + updateJobInDatabase(Job)
    + getAgentStatus(String) : AgentState
    + getModels() : List<String>
    + getRepositories() : List<String>
  }
  
  class JobProcessor {
    - JobRepository jobRepository
    - WorkflowFileService workflowFileService
    - SequenceWorkflowHandler sequenceWorkflowHandler
    - ParallelWorkflowHandler parallelWorkflowHandler
    - ChildWorkflowHandler childWorkflowHandler
    + processJobs()
  }
  
  class WorkflowFileService {
    - WorkflowParser workflowParser
    + parseWorkflow(String) : WorkflowData
  }
  
  class AgentLauncher {
    - CLIAgent cliAgent
    - JobRepository jobRepository
    - WorkflowFileService workflowFileService
    + launchAgent(Job, PromptInfo) : String
  }
  
  class PromptProcessor {
    - CLIAgent cliAgent
    - WorkflowFileService workflowFileService
    + processPrompt(Job, Prompt, String) : String
  }
  
  class TimeoutManager {
    - JobRepository jobRepository
    + checkTimeout(Job) : boolean
    + markTimeout(Job)
  }
  
  class FallbackExecutor {
    - CLIAgent cliAgent
    - JobRepository jobRepository
    - WorkflowFileService workflowFileService
    + executeFallback(Job, WorkflowData)
  }
  
  class ResultExtractor {
    - CLIAgent cliAgent
    - JobRepository jobRepository
    + extractResult(Job, ParallelWorkflowData) : String
  }
}

package "info.jab.churrera.cli.service.handler" {
  class SequenceWorkflowHandler {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - AgentLauncher agentLauncher
    - PromptProcessor promptProcessor
    - TimeoutManager timeoutManager
    - FallbackExecutor fallbackExecutor
    + processWorkflow(Job, List<Prompt>, WorkflowData)
  }
  
  class ParallelWorkflowHandler {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - AgentLauncher agentLauncher
    - TimeoutManager timeoutManager
    - FallbackExecutor fallbackExecutor
    - ResultExtractor resultExtractor
    + processWorkflow(Job, WorkflowData)
  }
  
  class ChildWorkflowHandler {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - AgentLauncher agentLauncher
    - PromptProcessor promptProcessor
    - TimeoutManager timeoutManager
    - FallbackExecutor fallbackExecutor
    + processWorkflow(Job, WorkflowData, List<Prompt>)
  }
}

package "info.jab.churrera.cli.util" {
  class GitInfo {
    + print()
  }
  
  class JobXmlMapper {
    + toXml(Job, DateTimeFormatter) : String
    + fromDocument(String, DateTimeFormatter) : List<Job>
  }
  
  class PromptXmlMapper {
    + toXml(Prompt, DateTimeFormatter) : String
    + fromDocument(String, DateTimeFormatter) : List<Prompt>
  }
  
  class XmlUtils {
    + {static} methods
  }
}

' Relationships
ChurreraCLI --> RunCommand : creates
ChurreraCLI --> JobRepository
ChurreraCLI --> CLIAgent
ChurreraCLI --> JobProcessor
ChurreraCLI --> WorkflowParser
ChurreraCLI --> WorkflowValidator
ChurreraCLI --> PmlValidator

RunCommand --> JobRepository
RunCommand --> JobProcessor
RunCommand --> CLIAgent
RunCommand --> JobCreationService
RunCommand --> JobDisplayService
RunCommand --> JobDeletionService
RunCommand --> JobLogDisplayService
RunCommand --> CompletionCheckerFactory

JobCreationService --> JobRepository
JobCreationService --> WorkflowValidator
JobCreationService --> WorkflowParser
JobCreationService --> PmlValidator
JobCreationService --> CLIAgent

JobDisplayService --> JobRepository
JobDeletionService --> JobRepository
JobDeletionService --> CLIAgent
JobLogDisplayService --> JobRepository
JobLogDisplayService --> CLIAgent

JobPollingService --> JobProcessor
JobPollingService --> JobRepository
JobPollingService --> JobDisplayService
JobPollingService --> CompletionCheckerFactory

CompletionCheckerFactory ..> CompletionChecker : creates
SimpleWorkflowCompletionChecker ..|> CompletionChecker
ParallelWorkflowCompletionChecker ..|> CompletionChecker
ParallelWorkflowCompletionChecker --> JobRepository

CLIAgent --> JobRepository
CLIAgent --> CursorAgentManagement
CLIAgent --> CursorAgentInformation
CLIAgent --> CursorAgentGeneralEndpoints
CLIAgent --> PmlConverter

JobProcessor --> JobRepository
JobProcessor --> WorkflowFileService
JobProcessor --> SequenceWorkflowHandler
JobProcessor --> ParallelWorkflowHandler
JobProcessor --> ChildWorkflowHandler

WorkflowFileService --> WorkflowParser

SequenceWorkflowHandler --> JobRepository
SequenceWorkflowHandler --> CLIAgent
SequenceWorkflowHandler --> AgentLauncher
SequenceWorkflowHandler --> PromptProcessor
SequenceWorkflowHandler --> TimeoutManager
SequenceWorkflowHandler --> FallbackExecutor

ParallelWorkflowHandler --> JobRepository
ParallelWorkflowHandler --> CLIAgent
ParallelWorkflowHandler --> AgentLauncher
ParallelWorkflowHandler --> TimeoutManager
ParallelWorkflowHandler --> FallbackExecutor
ParallelWorkflowHandler --> ResultExtractor

ChildWorkflowHandler --> JobRepository
ChildWorkflowHandler --> CLIAgent
ChildWorkflowHandler --> AgentLauncher
ChildWorkflowHandler --> PromptProcessor
ChildWorkflowHandler --> TimeoutManager
ChildWorkflowHandler --> FallbackExecutor

AgentLauncher --> CLIAgent
AgentLauncher --> JobRepository
AgentLauncher --> WorkflowFileService

PromptProcessor --> CLIAgent
PromptProcessor --> WorkflowFileService

TimeoutManager --> JobRepository
FallbackExecutor --> CLIAgent
FallbackExecutor --> JobRepository
FallbackExecutor --> WorkflowFileService

ResultExtractor --> CLIAgent
ResultExtractor --> JobRepository

JobRepository --> Job
JobRepository --> Prompt
JobRepository --> JobWithDetails
JobRepository --> JobXmlMapper
JobRepository --> PromptXmlMapper

Job --> AgentState
Job --> WorkflowType
JobWithDetails --> Job
JobWithDetails --> Prompt

@enduml
