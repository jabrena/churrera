@startuml
!theme plain
scale 0.6
title Churrera CLI Module Class Diagram

package "info.jab.churrera.cli" {
  class ChurreraCLI {
    - apiKeyResolver: CursorApiKeyResolver
    - propertyResolver: PropertyResolver
    - jobRepository: JobRepository
    - apiClient: ApiClient
    - defaultApi: DefaultApi
    - cliAgent: CLIAgent
    - workflowParser: WorkflowParser
    - jobProcessor: JobProcessor
    - workflowValidator: WorkflowValidator
    - pmlValidator: PmlValidator
    - apiKey: String
    + ChurreraCLI()
    + createRunCmd(): RunCommand
    + run(): void
    + main(String[]): void
    # printBanner(Supplier<GitInfo>): void
  }
}

package "info.jab.churrera.cli.command.run" {
  class RunCommand {
    - workflowPath: String
    - deleteOnCompletion: boolean
    - deleteOnSuccessCompletion: boolean
    - retrieveModels: boolean
    - retrieveRepositories: boolean
    - showLogs: boolean
    - pollingIntervalOverride: Integer
    - jobRepository: JobRepository
    - jobProcessor: JobProcessor
    - pollingIntervalSeconds: int
    - cliAgent: CLIAgent
    - jobCreationService: JobCreationService
    - jobDisplayService: JobDisplayService
    - jobDeletionService: JobDeletionService
    - jobLogDisplayService: JobLogDisplayService
    - completionCheckerFactory: CompletionCheckerFactory
    + call(): Integer
    + getJobRepository(): JobRepository
    - handleEarlyReturnOptions(): Integer
    - validateWorkflowPath(): boolean
    - logPollingInterval(): void
    - determineExitCode(ExecutionResult): int
    - printErrors(List<String>): void
    - retrieveAndDisplayModels(): void
    - retrieveAndDisplayRepositories(): void
  }
  
  interface CompletionChecker {
    + isComplete(String): CompletionCheckResult
  }
  
  class SimpleWorkflowCompletionChecker {
    - jobRepository: JobRepository
    + isComplete(String): CompletionCheckResult
  }
  
  class ParallelWorkflowCompletionChecker {
    - jobRepository: JobRepository
    + isComplete(String): CompletionCheckResult
  }
  
  class CompletionCheckerFactory {
    - jobRepository: JobRepository
    + createChecker(WorkflowData): CompletionChecker
  }
  
  class JobCreationService {
    - jobRepository: JobRepository
    - workflowValidator: WorkflowValidator
    - workflowParser: WorkflowParser
    - pmlValidator: PmlValidator
    - cliAgent: CLIAgent
    + createJob(String): JobCreationResult
  }
  
  class JobDisplayService {
    - jobRepository: JobRepository
    + displayJobStatus(String): void
  }
  
  class JobDeletionService {
    - jobRepository: JobRepository
    - cliAgent: CLIAgent
    + handleDeletion(String, Job, List<Job>, boolean, boolean): void
  }
  
  class JobLogDisplayService {
    - jobRepository: JobRepository
    - cliAgent: CLIAgent
    + displayLogsForJob(Job): void
  }
  
  class JobPollingService {
    - jobProcessor: JobProcessor
    - jobRepository: JobRepository
    - jobDisplayService: JobDisplayService
    - completionCheckerFactory: CompletionCheckerFactory
    - pollingIntervalSeconds: int
    + executePollingLoop(String): ExecutionResult
  }
  
  class TableFormatter {
    + formatJobTable(List<Job>): String
  }
  
  class ExecutionResult {
    + isInterrupted(): boolean
    + getFinalStatus(): AgentState
    + getChildJobs(): List<Job>
  }
  
  class JobCreationResult {
    + isSuccess(): boolean
    + getJobId(): String
    + getErrors(): List<String>
  }
  
  class CompletionCheckResult {
    + isComplete(): boolean
    + getStatus(): AgentState
  }
}

package "info.jab.churrera.cli.model" {
  class Job {
    + jobId(): String
    + path(): String
    + status(): AgentState
    + cursorAgentId(): String
    + model(): String
    + repository(): String
    + timeoutMillis(): Long
    + workflowStartTime(): LocalDateTime
    + fallbackExecuted(): Boolean
    + parentJobId(): String
    + result(): String
    + withCursorAgentId(String): Job
    + withStatus(AgentState): Job
    + withPath(String): Job
    + withWorkflowStartTime(LocalDateTime): Job
  }
  
  class JobWithDetails {
    + getJob(): Job
    + getPrompts(): List<Prompt>
  }
  
  class Prompt {
    + promptId(): String
    + jobId(): String
    + status(): String
    + withStatus(String): Prompt
  }
  
  class AgentState {
    + isActive(): boolean
    + isSuccessful(): boolean
    + isFailed(): boolean
    + isTerminal(): boolean
    + of(AgentResponse): AgentState
    + creating(): AgentState
    + error(): AgentState
  }
}

package "info.jab.churrera.cli.repository" {
  class JobRepository {
    - propertyResolver: PropertyResolver
    + save(Job): void
    + findById(String): Optional<Job>
    + findUnfinishedJobs(): List<Job>
    + findJobWithDetails(String): Optional<JobWithDetails>
    + savePrompt(Prompt): void
    + close(): void
  }
}

package "info.jab.churrera.cli.service" {
  class CLIAgent {
    - cursorAgentManagement: CursorAgentManagement
    - cursorAgentInformation: CursorAgentInformation
    - cursorAgentGeneralEndpoints: CursorAgentGeneralEndpoints
    - jobRepository: JobRepository
    - pmlConverter: PmlConverter
    + launchAgentForJob(Job, String, String, String, boolean): String
    + followUpForPrompt(String, String, String, String): String
    + monitorAgent(String, int): AgentState
    + getConversation(String): ConversationResponse
    + getConversationContent(String): String
    + deleteAgent(String): void
    + updateJobCursorIdInDatabase(Job, String, AgentState): void
    + updateJobStatusInDatabase(Job, AgentState): void
    + updatePromptInDatabase(Prompt, String): void
    + updateJobInDatabase(Job): void
    + getAgentStatus(String): AgentState
    + getModels(): List<String>
    + getRepositories(): List<String>
  }
  
  class JobProcessor {
    - jobRepository: JobRepository
    - workflowFileService: WorkflowFileService
    - sequenceWorkflowHandler: SequenceWorkflowHandler
    - parallelWorkflowHandler: ParallelWorkflowHandler
    - childWorkflowHandler: ChildWorkflowHandler
    + processJobs(): void
    - processJob(Job): void
    - processJobWorkflow(Job, List<Prompt>): void
    - processSingleJob(Job): void
  }
  
  class AgentLauncher {
    - cliAgent: CLIAgent
    - jobRepository: JobRepository
    - workflowFileService: WorkflowFileService
    + launchJobAgent(Job, WorkflowData): void
  }
  
  class PromptProcessor {
    - cliAgent: CLIAgent
    - workflowFileService: WorkflowFileService
    + processRemainingPrompts(Job, List<Prompt>, WorkflowData): void
    + processPrompt(Job, Prompt, PromptInfo): void
  }
  
  class TimeoutManager {
    - jobRepository: JobRepository
    + checkTimeout(Job): TimeoutCheckResult
    + resetWorkflowStartTimeIfNeeded(Job): Job
    + resetStaleWorkflowStartTime(Job): Job
  }
  
  class FallbackExecutor {
    - cliAgent: CLIAgent
    - jobRepository: JobRepository
    - workflowFileService: WorkflowFileService
    + executeFallback(Job, WorkflowData, long, long): void
  }
  
  class ResultExtractor {
    - cliAgent: CLIAgent
    - jobRepository: JobRepository
    + extractResult(String): String
  }
  
  class WorkflowFileService {
    - workflowParser: WorkflowParser
    + parseWorkflow(String): WorkflowData
    + readPromptFile(String, String): String
  }
  
  package "handler" {
    class SequenceWorkflowHandler {
      - jobRepository: JobRepository
      - cliAgent: CLIAgent
      - agentLauncher: AgentLauncher
      - promptProcessor: PromptProcessor
      - timeoutManager: TimeoutManager
      - fallbackExecutor: FallbackExecutor
      + processWorkflow(Job, List<Prompt>, WorkflowData): void
      - checkAndUpdateJobStatus(Job, List<Prompt>, WorkflowData): void
    }
    
    class ParallelWorkflowHandler {
      - jobRepository: JobRepository
      - cliAgent: CLIAgent
      - agentLauncher: AgentLauncher
      - timeoutManager: TimeoutManager
      - fallbackExecutor: FallbackExecutor
      - resultExtractor: ResultExtractor
      + processWorkflow(Job, WorkflowData): void
    }
    
    class ChildWorkflowHandler {
      - jobRepository: JobRepository
      - cliAgent: CLIAgent
      - agentLauncher: AgentLauncher
      - promptProcessor: PromptProcessor
      - timeoutManager: TimeoutManager
      - fallbackExecutor: FallbackExecutor
      + processWorkflow(Job, WorkflowData, List<Prompt>): void
    }
  }
}

package "info.jab.churrera.cli.util" {
  class GitInfo {
    + print(): void
  }
  
  class JobXmlMapper {
    + toXml(Job): String
    + fromXml(String): Job
  }
  
  class PromptXmlMapper {
    + toXml(Prompt): String
    + fromXml(String): Prompt
  }
  
  class XmlUtils {
    + escapeXml(String): String
  }
}

' Relationships
ChurreraCLI --> RunCommand : creates
ChurreraCLI --> JobRepository
ChurreraCLI --> CLIAgent
ChurreraCLI --> JobProcessor
ChurreraCLI --> WorkflowParser
ChurreraCLI --> WorkflowValidator
ChurreraCLI --> PmlValidator

RunCommand --> JobRepository
RunCommand --> JobProcessor
RunCommand --> CLIAgent
RunCommand --> JobCreationService
RunCommand --> JobDisplayService
RunCommand --> JobDeletionService
RunCommand --> JobLogDisplayService
RunCommand --> CompletionCheckerFactory

SimpleWorkflowCompletionChecker ..|> CompletionChecker : implements
ParallelWorkflowCompletionChecker ..|> CompletionChecker : implements
CompletionCheckerFactory --> CompletionChecker : creates

JobProcessor --> SequenceWorkflowHandler
JobProcessor --> ParallelWorkflowHandler
JobProcessor --> ChildWorkflowHandler
JobProcessor --> WorkflowFileService

SequenceWorkflowHandler --> AgentLauncher
SequenceWorkflowHandler --> PromptProcessor
SequenceWorkflowHandler --> TimeoutManager
SequenceWorkflowHandler --> FallbackExecutor

ParallelWorkflowHandler --> AgentLauncher
ParallelWorkflowHandler --> TimeoutManager
ParallelWorkflowHandler --> FallbackExecutor
ParallelWorkflowHandler --> ResultExtractor

ChildWorkflowHandler --> AgentLauncher
ChildWorkflowHandler --> PromptProcessor
ChildWorkflowHandler --> TimeoutManager
ChildWorkflowHandler --> FallbackExecutor

CLIAgent --> CursorAgentManagement
CLIAgent --> CursorAgentInformation
CLIAgent --> CursorAgentGeneralEndpoints
CLIAgent --> JobRepository
CLIAgent --> PmlConverter

AgentLauncher --> CLIAgent
AgentLauncher --> JobRepository
AgentLauncher --> WorkflowFileService

PromptProcessor --> CLIAgent
PromptProcessor --> WorkflowFileService

JobRepository --> Job
JobRepository --> JobWithDetails
JobRepository --> Prompt

JobWithDetails --> Job
JobWithDetails --> Prompt

@enduml
