@startuml
!theme plain
title Churrera CLI Module - Class Diagram

package "info.jab.churrera.cli" {
    class ChurreraCLI {
        -logger: Logger
        +createCLICommand(): ChurreraCLICommand
        +createRunCommand(): RunCommand
        +run(): void
        +main(String[]): void
    }
}

package "info.jab.churrera.cli.command" {
    interface Runnable {
    }
    
    class ChurreraCLICommand implements Runnable {
        -jobRepository: JobRepository
        -jobProcessor: JobProcessor
        -propertyResolver: PropertyResolver
        -scanner: Scanner
        -cliAgent: CLIAgent
        +run(): void
    }
    
    class RunCommand implements Runnable {
        -jobRepository: JobRepository
        -jobProcessor: JobProcessor
        -workflowValidator: WorkflowValidator
        -workflowParser: WorkflowParser
        -pmlValidator: PmlValidator
        -pollingIntervalSeconds: int
        +run(): void
    }
    
    class JobsCommand implements Runnable {
        -jobRepository: JobRepository
        +run(): void
    }
    
    class NewJobCommand implements Runnable {
        -jobRepository: JobRepository
        -cliAgent: CLIAgent
        +run(): void
    }
    
    class JobStatusCommand implements Runnable {
        -jobRepository: JobRepository
        +run(): void
    }
    
    class JobLogsCommand implements Runnable {
        -jobRepository: JobRepository
        -cliAgent: CLIAgent
        +run(): void
    }
    
    class DeleteJobCommand implements Runnable {
        -jobRepository: JobRepository
        +run(): void
    }
    
    class NewJobRunCommand implements Runnable {
        -jobRepository: JobRepository
        -jobProcessor: JobProcessor
        +run(): void
    }
    
    class JobsPrCommand implements Runnable {
        -jobRepository: JobRepository
        +run(): void
    }
    
    class TableFormatter {
        +formatJobs(List<Job>): String
    }
}

package "info.jab.churrera.cli.model" {
    record Job {
        +jobId: String
        +path: String
        +cursorAgentId: String
        +model: String
        +repository: String
        +status: AgentState
        +createdAt: LocalDateTime
        +lastUpdate: LocalDateTime
        +parentJobId: String
        +result: String
        +type: WorkflowType
        +timeoutMillis: Long
        +workflowStartTime: LocalDateTime
        +fallbackSrc: String
        +fallbackExecuted: Boolean
        +withPath(String): Job
        +withCursorAgentId(String): Job
        +withStatus(AgentState): Job
    }
    
    class JobWithDetails {
        -job: Job
        -prompts: List<Prompt>
        +getJob(): Job
        +getPrompts(): List<Prompt>
    }
    
    record Prompt {
        +promptId: String
        +jobId: String
        +pmlFile: String
        +status: String
        +createdAt: LocalDateTime
        +lastUpdate: LocalDateTime
        +withStatus(String): Prompt
    }
}

package "info.jab.churrera.cli.repository" {
    class JobRepository {
        -context: Context
        -databasePath: String
        -initialized: boolean
        +initialize(): void
        +findAll(): List<Job>
        +findById(String): Optional<Job>
        +save(Job): void
        +deleteById(String): void
        +savePrompt(Prompt): void
        +findPromptById(String): Optional<Prompt>
        +findPromptsByJobId(String): List<Prompt>
        +findJobWithDetails(String): Optional<JobWithDetails>
        +findUnfinishedJobs(): List<Job>
        +close(): void
    }
}

package "info.jab.churrera.cli.service" {
    class CLIAgent {
        -cursorAgentManagement: CursorAgentManagement
        -cursorAgentInformation: CursorAgentInformation
        -jobRepository: JobRepository
        -pmlConverter: PmlConverter
        -propertyResolver: PropertyResolver
        +launchAgentForJob(Job, String, String, String, boolean): String
        +followUpForPrompt(String, String, String, String): String
        +monitorAgent(String, int): AgentState
        +getConversation(String): ConversationResponse
        +getConversationContent(String): String
        +deleteAgent(String): void
        +updateJobCursorIdInDatabase(Job, String, AgentState): void
        +updateJobStatusInDatabase(Job, AgentState): void
        +getAgentStatus(String): AgentState
    }
    
    class JobProcessor {
        -jobRepository: JobRepository
        -cliAgent: CLIAgent
        -workflowParser: WorkflowParser
        -pollingIntervalSeconds: int
        +processJob(Job): void
    }
}

package "info.jab.churrera.cli.util" {
    class GitInfo {
        +print(): void
    }
}

package "info.jab.churrera.workflow" {
    class WorkflowParser {
        +parse(File): WorkflowData
        +parse(Path): WorkflowData
        +determineWorkflowType(File): WorkflowType
    }
    
    class WorkflowData {
        -launchPrompt: PromptInfo
        -model: String
        -repository: String
        -updatePrompts: List<PromptInfo>
        -parallelWorkflowData: ParallelWorkflowData
        -timeoutMillis: Long
        -fallbackSrc: String
        +getLaunchPrompt(): PromptInfo
        +getModel(): String
        +getRepository(): String
        +getUpdatePrompts(): List<PromptInfo>
        +isParallelWorkflow(): boolean
    }
    
    class WorkflowValidator {
        +validate(WorkflowData): void
    }
    
    class PmlValidator {
        +validate(File): void
    }
    
    enum WorkflowType {
        SEQUENCE
        PARALLEL
    }
}

package "info.jab.churrera.agent" {
    enum AgentState {
        PENDING
        RUNNING
        COMPLETED
        FAILED
        UNKNOWN
        +isTerminal(): boolean
    }
}

package "info.jab.churrera.util" {
    class CursorApiKeyResolver {
        +resolveApiKey(): String
    }
    
    class PropertyResolver {
        +getProperty(String, String): Optional<String>
    }
    
    class PmlConverter {
        +toMarkdownFromContent(String): String
        +toMarkdownFromContent(String, String): String
    }
}

package "info.jab.cursor" {
    interface CursorAgentManagement {
        +launch(String, String, String, boolean): AgentResponse
        +followUp(String, String): FollowUpResponse
        +delete(String): DeleteAgentResponse
    }
    
    interface CursorAgentInformation {
        +getStatus(String): AgentResponse
        +getAgentConversation(String): ConversationResponse
    }
    
    class CursorAgentManagementImpl implements CursorAgentManagement {
        -apiKey: String
        -apiBaseUrl: String
        +launch(String, String, String, boolean): AgentResponse
        +followUp(String, String): FollowUpResponse
        +delete(String): DeleteAgentResponse
    }
    
    class CursorAgentInformationImpl implements CursorAgentInformation {
        -apiKey: String
        -apiBaseUrl: String
        +getStatus(String): AgentResponse
        +getAgentConversation(String): ConversationResponse
    }
}

ChurreraCLI --> ChurreraCLICommand
ChurreraCLI --> RunCommand
ChurreraCLI --> JobRepository
ChurreraCLI --> WorkflowParser
ChurreraCLI --> CLIAgent
ChurreraCLI --> CursorAgentManagementImpl
ChurreraCLI --> CursorAgentInformationImpl

ChurreraCLICommand --> JobRepository
ChurreraCLICommand --> JobProcessor
ChurreraCLICommand --> CLIAgent
ChurreraCLICommand --> PropertyResolver

RunCommand --> JobRepository
RunCommand --> JobProcessor
RunCommand --> WorkflowValidator
RunCommand --> WorkflowParser
RunCommand --> PmlValidator

JobsCommand --> JobRepository
NewJobCommand --> JobRepository
NewJobCommand --> CLIAgent
JobStatusCommand --> JobRepository
JobLogsCommand --> JobRepository
JobLogsCommand --> CLIAgent
DeleteJobCommand --> JobRepository
NewJobRunCommand --> JobRepository
NewJobRunCommand --> JobProcessor

CLIAgent --> JobRepository
CLIAgent --> CursorAgentManagement
CLIAgent --> CursorAgentInformation
CLIAgent --> PmlConverter
CLIAgent --> PropertyResolver
CLIAgent --> Job
CLIAgent --> AgentState

JobProcessor --> JobRepository
JobProcessor --> CLIAgent
JobProcessor --> WorkflowParser
JobProcessor --> Job

JobRepository --> Job
JobRepository --> Prompt
JobRepository --> JobWithDetails
JobRepository --> PropertyResolver

WorkflowParser --> WorkflowData
WorkflowData --> PromptInfo
WorkflowData --> ParallelWorkflowData
WorkflowData --> WorkflowType

Job --> AgentState
Job --> WorkflowType

CursorAgentManagementImpl ..|> CursorAgentManagement
CursorAgentInformationImpl ..|> CursorAgentInformation

@enduml
