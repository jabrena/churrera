@startuml
!theme plain
scale 0.6
title Churrera Core Module - Class Diagram

package "info.jab.churrera.workflow" {
  class WorkflowParser {
    + parse(File) : WorkflowData
    + parse(Path) : WorkflowData
    + {static} determineWorkflowType(File) : WorkflowType
    - parseV2Workflow(Node) : WorkflowData
    - parseParallelWorkflow(Element) : WorkflowData
    - parseSequenceInfo(Element) : SequenceInfo
    - inferTypeFromExtension(String) : String
  }
  
  class WorkflowValidator {
    - PropertyResolver propertyResolver
    + validate(File) : ValidationResult
    + validate(Path) : ValidationResult
    + validateTimeoutAndFallback(File, WorkflowData) : List<String>
    + validateFallbackFile(File, String) : List<String>
    - loadSchema() : Schema
    - getSchemaUrl() : String
    - createSecureSchemaFactory() : SchemaFactory
    + ValidationResult
    + ValidationErrorHandler
  }
  
  class PmlValidator {
    - PropertyResolver propertyResolver
    + validate(File) : ValidationResult
    + validate(Path) : ValidationResult
    - loadSchema() : Schema
    - getSchemaUrl() : String
    - createSecureSchemaFactory() : SchemaFactory
    + ValidationResult
    + ValidationErrorHandler
  }
  
  class WorkflowData {
    - PromptInfo launchPrompt
    - String model
    - String repository
    - List<PromptInfo> updatePrompts
    - ParallelWorkflowData parallelWorkflowData
    - Long timeoutMillis
    - String fallbackSrc
    + getLaunchPrompt() : PromptInfo
    + getModel() : String
    + getRepository() : String
    + getUpdatePrompts() : List<PromptInfo>
    + getParallelWorkflowData() : ParallelWorkflowData
    + isParallelWorkflow() : boolean
    + getUpdateAgentCount() : int
    + hasUpdateAgents() : boolean
    + getTimeoutMillis() : Long
    + getFallbackSrc() : String
  }
  
  class ParallelWorkflowData {
    - PromptInfo parallelPrompt
    - String bindResultType
    - List<SequenceInfo> sequences
    - Long timeoutMillis
    - String fallbackSrc
    + getParallelPrompt() : PromptInfo
    + getBindResultType() : String
    + getSequences() : List<SequenceInfo>
    + getTimeoutMillis() : Long
    + getFallbackSrc() : String
  }
  
  class SequenceInfo {
    - String model
    - String repository
    - List<PromptInfo> prompts
    - Long timeoutMillis
    - String fallbackSrc
    + getModel() : String
    + getRepository() : String
    + getPrompts() : List<PromptInfo>
    + getTimeoutMillis() : Long
    + getFallbackSrc() : String
  }
  
  class PromptInfo {
    - String srcFile
    - String type
    - String bindResultExp
    + getSrcFile() : String
    + getType() : String
    + getBindResultExp() : String
  }
  
  enum WorkflowType {
    SEQUENCE
    PARALLEL
  }
  
  class WorkflowParseException {
    + WorkflowParseException(String)
    + WorkflowParseException(String, Throwable)
  }
  
  class TimeoutParser {
    + {static} parseToMillis(String) : Long
  }
  
  class ExpressionEvaluator {
    + {static} replaceInputPlaceholder(String, String) : String
  }
  
  class BindResultTypeMapper {
    + {static} mapBindResultType(String) : String
  }
}

package "info.jab.churrera.util" {
  class PropertyResolver {
    + getProperty(String, String) : Optional<String>
  }
  
  class CursorApiKeyResolver {
    + resolveApiKey() : String
  }
  
  class PmlConverter {
    + toMarkdownFromContent(String) : String
    + toMarkdownFromContent(String, String) : String
  }
  
  class ClasspathResolver {
    + {static} resolveResource(String) : InputStream
  }
  
  class ConversationJsonDeserializer {
    + deserialize(String) : String
  }
}

' Relationships
WorkflowParser --> WorkflowData : creates
WorkflowParser --> ParallelWorkflowData : creates
WorkflowParser --> SequenceInfo : creates
WorkflowParser --> PromptInfo : creates
WorkflowParser --> TimeoutParser
WorkflowParser --> WorkflowParseException : throws

WorkflowValidator --> PropertyResolver
WorkflowValidator --> WorkflowData
WorkflowValidator --> ValidationResult : returns
WorkflowValidator --> ValidationErrorHandler : uses

PmlValidator --> PropertyResolver
PmlValidator --> ValidationResult : returns
PmlValidator --> ValidationErrorHandler : uses

WorkflowData --> PromptInfo
WorkflowData --> ParallelWorkflowData
WorkflowData --> SequenceInfo

ParallelWorkflowData --> PromptInfo
ParallelWorkflowData --> SequenceInfo

SequenceInfo --> PromptInfo

WorkflowData --> WorkflowType

PmlConverter --> ClasspathResolver

@enduml
